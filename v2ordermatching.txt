const FOLDER_ID = '1wQm-ZJAFFEfOtPW568JW8u8hEiEWVrK8';
const TEMPLATE_SHEET_ID = '1cCABlF0p7JFdPW-lIqCq_am0SuKi5xR9YWJW61JJzPU'; // Updated template file


const ERROR_EMAIL = 'hemantpb123@gmail.com';
const ORDER_EMAIL = 'hemantpb456@gmail.com'; // Email to send processed orders
const ORDER_EMAIL_CC = 'photobackuphb@gmail.com'; // CC recipients


//const ERROR_EMAIL = 'hreenkarcreation@gmail.com';
//const ORDER_EMAIL = 'vishalkulkarni@modenik.in'; // Email to send processed orders
//const ORDER_EMAIL_CC = 'Ganapati.TS@modenik.in,MANJUNATH.AVAROLKAR@modenik.in'; // CC recipients

/**
 * Convert Excel template to Google Sheets (one-time setup)
 */
function convertTemplateToGoogleSheets() {
  try {
    console.log('Converting Excel template to Google Sheets...');
    
    const excelFile = DriveApp.getFileById(TEMPLATE_SHEET_ID);
    console.log('Excel file:', excelFile.getName());
    console.log('MIME type:', excelFile.getMimeType());
    
    // Get the blob and convert to Google Sheets
    const blob = excelFile.getBlob();
    const folder = DriveApp.getFolderById(FOLDER_ID);
    
    // Create Google Sheets version
    const resource = {
      title: excelFile.getName().replace('.xlsx', '') + '_TEMPLATE',
      mimeType: MimeType.GOOGLE_SHEETS,
      parents: [{ id: folder.getId() }]
    };
    
    const sheetsFile = Drive.Files.insert(resource, blob, { convert: true });
    console.log('âœ… Converted to Google Sheets');
    console.log('New file ID:', sheetsFile.id);
    console.log('New file URL:', sheetsFile.alternateLink);
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('IMPORTANT: Update TEMPLATE_SHEET_ID to:', sheetsFile.id);
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    
    return sheetsFile.id;
  } catch (err) {
    console.error('Conversion failed:', err);
    return 'ERROR: ' + err.message;
  }
}

// Test function to verify access
function testAccess() {
  try {
    console.log('Testing folder access...');
    const folder = DriveApp.getFolderById(FOLDER_ID);
    console.log('âœ… Folder accessible:', folder.getName());
    
    console.log('Testing template file via Drive...');
    const templateFile = DriveApp.getFileById(TEMPLATE_SHEET_ID);
    console.log('âœ… Template file accessible via Drive');
    console.log('File name:', templateFile.getName());
    console.log('File MIME type:', templateFile.getMimeType());
    console.log('File URL:', templateFile.getUrl());
    
    // Check if it's a Google Sheets file
    const expectedMimeType = 'application/vnd.google-apps.spreadsheet';
    if (templateFile.getMimeType() !== expectedMimeType) {
      console.error('âŒ Wrong MIME type! Expected:', expectedMimeType);
      console.error('Got:', templateFile.getMimeType());
      console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      console.error('RUN convertTemplateToGoogleSheets() to fix this!');
      console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      return 'ERROR: File is not a Google Sheets file! Run convertTemplateToGoogleSheets()';
    }
    
    console.log('Testing template access via Spreadsheet service...');
    const template = SpreadsheetApp.openById(TEMPLATE_SHEET_ID);
    console.log('âœ… Template accessible:', template.getName());
    console.log('Sheet count:', template.getSheets().length);
    console.log('First sheet name:', template.getSheets()[0].getName());
    
    console.log('Testing template copy...');
    const testCopy = DriveApp.getFileById(TEMPLATE_SHEET_ID).makeCopy('TEST_ACCESS_' + new Date().getTime());
    console.log('âœ… Can create copy:', testCopy.getName());
    
    console.log('Deleting test copy...');
    testCopy.setTrashed(true);
    console.log('âœ… All access tests passed!');
    
    return 'All tests passed successfully!';
  } catch (err) {
    console.error('âŒ Access test failed:', err.message);
    console.error('Error stack:', err.stack);
    return 'Test failed: ' + err.message;
  }
}

/**
 * Handle POST requests from the app
 */
function doPost(e) {
  try {
    return handleRequest(e);
  } catch (err) {
    console.error('Error:', err);
    sendErrorEmail(err.message);
    return ContentService.createTextOutput(
      JSON.stringify({
        status: 'error',
        message: 'âŒ Error: ' + err.message
      })
    ).setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Handle GET requests (health check)
 */
function doGet(e) {
  return ContentService.createTextOutput(
    'ğŸŸ¢ Order Processing Endpoint is active.'
  ).setMimeType(ContentService.MimeType.TEXT);
}

/**
 * Process incoming request
 */
function handleRequest(e) {
  try {
    console.log('Received request');
    console.log('Parameters:', Object.keys(e.parameter || {}));
    
    // Check if JSON data is present
    if (!e.parameter.jsonData) {
      console.error('No jsonData parameter found');
      throw new Error('No JSON data received');
    }
    
    console.log('JSON data received, length:', e.parameter.jsonData.length);
    
    // Decode base64 JSON
    const jsonBase64 = e.parameter.jsonData;
    
    let jsonString;
    try {
      jsonString = Utilities.newBlob(
        Utilities.base64Decode(jsonBase64)
      ).getDataAsString();
      console.log('âœ… Base64 decoded successfully');
    } catch (decodeErr) {
      console.error('Base64 decode error:', decodeErr);
      throw new Error('Failed to decode base64 data: ' + decodeErr.message);
    }
    
    let orderData;
    try {
      orderData = JSON.parse(jsonString);
      console.log('âœ… JSON parsed successfully');
    } catch (parseErr) {
      console.error('JSON parse error:', parseErr);
      console.error('JSON string preview:', jsonString.substring(0, 200));
      throw new Error('Failed to parse JSON: ' + parseErr.message);
    }
    
    console.log('Order Number:', orderData.orderNumber);
    console.log('Party Name:', orderData.partyName);
    console.log('Items count:', orderData.items ? orderData.items.length : 0);
    
    // Validate order data
    if (!orderData.items || orderData.items.length === 0) {
      throw new Error('No items in order data');
    }
    
    // Get folder and save JSON file
    const folder = DriveApp.getFolderById(FOLDER_ID);
    const jsonFile = saveJsonFile(folder, orderData);
    console.log('âœ… JSON file saved:', jsonFile.getName());
    
    // Process order immediately
    processOrder(orderData, folder);
    
    return ContentService.createTextOutput(
      JSON.stringify({
        status: 'success',
        message: 'âœ… Order received and processing started.',
        items: orderData.items.length
      })
    ).setMimeType(ContentService.MimeType.JSON);
    
  } catch (err) {
    console.error('Request handling error:', err);
    console.error('Error stack:', err.stack);
    throw err;
  }
}

/**
 * Save JSON data to Drive folder
 */
function saveJsonFile(folder, orderData) {
  try {
    const timestamp = new Date().toLocaleString('en-IN', { 
      timeZone: 'Asia/Kolkata',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    }).replace(/\//g, '-').replace(/:/g, '-').replace(/,/g, '');
    
    const fileName = `ORDER_${orderData.orderNumber}_${timestamp}.json`;
    
    // Create JSON blob
    const jsonBlob = Utilities.newBlob(
      JSON.stringify(orderData, null, 2),
      'application/json',
      fileName
    );
    
    // Save to folder
    const jsonFile = folder.createFile(jsonBlob);
    console.log('JSON file created:', fileName);
    
    return jsonFile;
  } catch (err) {
    console.error('Failed to save JSON file:', err);
    // Don't throw - continue processing even if file save fails
    return null;
  }
}

/**
 * Process the order data
 */
function processOrder(orderData, folder) {
  try {
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('Processing order:', orderData.orderNumber);
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    
    const items = orderData.items;
    
    console.log('Total items to process:', items.length);
    
    // Try to open template sheet
    let templateSheet;
    try {
      console.log('Attempting to open template sheet:', TEMPLATE_SHEET_ID);
      templateSheet = SpreadsheetApp.openById(TEMPLATE_SHEET_ID);
      console.log('âœ… Template sheet opened successfully');
    } catch (err) {
      console.error('âŒ Failed to open template sheet');
      throw new Error('Cannot access template sheet. Please ensure:\n' +
        '1. Template sheet ID is correct\n' +
        '2. Template is shared with script owner\n' +
        '3. Template has not been deleted\n' +
        'Original error: ' + err.message);
    }
    
    // Create template copy
    const processedSheet = createProcessedCopy(templateSheet, orderData);
    console.log('âœ… Template copy created:', processedSheet.getName());
    
    // Match and fill
    const matchResult = matchAndFillQuantities(processedSheet, items);
    console.log('âœ… Matching complete - Matched:', matchResult.matched, 'Unmatched:', matchResult.unmatched.length);
    
    // Apply filter to hide blank cells in column O
    applyFilterToSheet(processedSheet);
    console.log('âœ… Filter applied to column O');
    
    // Send email
    sendCompletionEmail(orderData, processedSheet, matchResult);
    console.log('âœ… Processing complete');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    
  } catch (err) {
    console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.error('âŒ Processing error:', err);
    console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    
    // Send detailed error email with order data
    const debugInfo = orderData ? {
      orderData: {
        orderNumber: orderData.orderNumber,
        partyName: orderData.partyName,
        orderDate: orderData.orderDate
      },
      items: orderData.items
    } : null;
    
    sendErrorEmail('Order Processing Failed: ' + err.message + '\n\nOrder: ' + (orderData ? orderData.orderNumber : 'Unknown'), debugInfo);
    throw err;
  }
}

/**
 * Create a copy of the template sheet
 */
function createProcessedCopy(templateSheet, orderData) {
  try {
    console.log('Opening template with ID:', TEMPLATE_SHEET_ID);
    
    // Get template file with retry logic
    let templateFile;
    try {
      templateFile = DriveApp.getFileById(TEMPLATE_SHEET_ID);
      console.log('Template file accessed via Drive');
    } catch (driveErr) {
      console.log('Drive access failed, trying via Spreadsheet');
      templateFile = templateSheet.getParent();
    }
    
    console.log('Template file name:', templateFile.getName());
    console.log('Template file ID:', templateFile.getId());
    
    const folder = DriveApp.getFolderById(FOLDER_ID);
    console.log('Target folder name:', folder.getName());
    
    const timestamp = new Date().toLocaleString('en-IN', { 
      timeZone: 'Asia/Kolkata',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    }).replace(/\//g, '-').replace(/:/g, '-').replace(/,/g, '_');
    
    // Removed party name from filename
    const copyName = `ORDER_${orderData.orderNumber}_${timestamp}`.replace(/\s+/g, '_');
    
    console.log('Creating copy:', copyName);
    
    // Create copy with error handling
    let copiedFile;
    try {
      copiedFile = templateFile.makeCopy(copyName, folder);
      console.log('âœ… Copy created with ID:', copiedFile.getId());
    } catch (copyErr) {
      console.error('makeCopy failed:', copyErr.message);
      // Try alternative method
      console.log('Trying alternative copy method...');
      const tempCopy = templateFile.makeCopy(copyName);
      copiedFile = tempCopy;
      // Move to folder
      folder.addFile(copiedFile);
      DriveApp.getRootFolder().removeFile(copiedFile);
      console.log('âœ… Copy created and moved to folder');
    }
    
    console.log('Opening copied spreadsheet...');
    const copiedSpreadsheet = SpreadsheetApp.openById(copiedFile.getId());
    console.log('âœ… Template copy ready:', copiedSpreadsheet.getName());
    
    return copiedSpreadsheet;
  } catch (err) {
    console.error('Template copy error details:', err);
    console.error('Error message:', err.message);
    console.error('Error stack:', err.stack);
    throw new Error('Failed to create template copy: ' + err.message + '\nPlease check template permissions and folder access');
  }
}

/**
 * Match order items with template and fill quantities using Barcode
 */
function matchAndFillQuantities(processedSheet, items) {
  try {
    const sheet = processedSheet.getSheets()[0];
    const templateData = sheet.getDataRange().getValues();
    
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('MATCHING DEBUG INFO (Barcode)');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('Template has', templateData.length, 'rows');
    
    // Column indices (0-based)
    const barcodeCol = 1;  // B - Barcode (column B = index 1)
    const qtyCol = 14;     // O - Order Qty (column O = index 14)
    
    console.log('Column mapping: Barcode=B(1), Qty=O(14)');
    
    // Create a map of barcodes to row index for faster lookup
    const barcodeMap = new Map();
    for (let i = 0; i < templateData.length; i++) {
        const row = templateData[i];
        if (row && row.length > barcodeCol) {
            const barcode = String(row[barcodeCol] || '').trim();
            if (barcode) {
                barcodeMap.set(barcode, i); // store 0-based row index
            }
        }
    }
    console.log('Created barcode map with', barcodeMap.size, 'entries');

    // Consolidate orders (combine same barcode)
    const consolidated = {};
    for (const item of items) {
      if (!item.barcode) continue;
      const key = String(item.barcode).trim();
      if (consolidated[key]) {
        consolidated[key].quantity += item.quantity;
      } else {
        consolidated[key] = {
          barcode: key,
          quantity: item.quantity
        };
      }
    }
    
    console.log('Consolidated items:', Object.keys(consolidated).length);
    console.log('Items to match:');
    for (const key in consolidated) {
      const item = consolidated[key];
      console.log(`  - Barcode: [${item.barcode}] | Qty: ${item.quantity}`);
    }
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    
    let matched = 0;
    const unmatched = [];
    
    // Match with template using the map
    for (const key in consolidated) {
      const orderItem = consolidated[key];
      const orderBarcode = orderItem.barcode;

      if (barcodeMap.has(orderBarcode)) {
        const rowIndex = barcodeMap.get(orderBarcode);
        const currentQty = Number(templateData[rowIndex][qtyCol]) || 0;
        const newQty = currentQty + orderItem.quantity;
        
        // Update quantity in the sheet
        sheet.getRange(rowIndex + 1, qtyCol + 1).setValue(newQty);
        
        console.log(`âœ“âœ“âœ“ MATCH FOUND for barcode [${orderBarcode}] at Row ${rowIndex + 1} â†’ New Qty: ${newQty}`);
        matched++;
      } else {
        const unmatchedLabel = `Barcode: [${orderBarcode}] (Qty: ${orderItem.quantity})`;
        unmatched.push(unmatchedLabel);
        console.log('âœ—âœ—âœ— NO MATCH FOUND for', unmatchedLabel);
      }
    }
    
    // Save changes
    SpreadsheetApp.flush();
    
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('MATCHING SUMMARY');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('Matched:', matched);
    console.log('Unmatched:', unmatched.length);
    if (unmatched.length > 0) {
      console.log('Unmatched items:');
      unmatched.forEach(item => console.log('  -', item));
      
      // Send detailed error email with unmatched items
      const debugInfo = {
        items: Object.values(consolidated),
        unmatched: unmatched
      };
      
      sendErrorEmail(
        `${unmatched.length} item(s) could not be matched by barcode`,
        debugInfo
      );
    }
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    
    return { matched, unmatched };
  } catch (err) {
    throw new Error('Failed to match quantities by barcode: ' + err.message);
  }
}

/**
 * Apply filter to column O to hide blank cells
 */
function applyFilterToSheet(spreadsheet) {
  try {
    const sheet = spreadsheet.getSheets()[0];
    const lastRow = sheet.getLastRow();
    const lastCol = sheet.getLastColumn();
    
    if (lastRow < 1 || lastCol < 15) {
      console.log('Sheet too small to apply filter');
      return;
    }
    
    // Remove existing filters first
    const existingFilter = sheet.getFilter();
    if (existingFilter) {
      existingFilter.remove();
      console.log('Removed existing filter');
    }
    
    // Create new filter on entire data range
    const range = sheet.getRange(1, 1, lastRow, lastCol);
    const filter = range.createFilter();
    console.log('âœ… Filter created on range:', range.getA1Notation());
    
    // Column O is the 15th column (index 15)
    // Set criteria to hide blank cells
    const criteria = SpreadsheetApp.newFilterCriteria()
      .whenCellNotEmpty()
      .build();
    
    filter.setColumnFilterCriteria(15, criteria);
    console.log('âœ… Filter applied to column O (15) - hiding blank cells');
    
    // Force refresh
    SpreadsheetApp.flush();
    
  } catch (err) {
    console.error('Filter application error:', err.message);
    console.error('Stack:', err.stack);
    // Don't throw - filter is optional, continue processing
  }
}

/**
 * Send completion email to user with XLSX attachment
 */
function sendCompletionEmail(orderData, processedSheet, matchResult) {
  try {
    const processedFileName = processedSheet.getName();
    const driveLink = processedSheet.getUrl();
    
    let unmatchedText = 'None âœ“';
    if (matchResult.unmatched.length > 0) {
      unmatchedText = matchResult.unmatched.join('\n');
    }
    
    const timestamp = new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });
    
    // Convert to XLSX first
    console.log('Converting to XLSX...');
    const xlsxBlob = convertSheetToXlsx(processedSheet, orderData.orderNumber);
    console.log('âœ… XLSX blob created:', xlsxBlob.getName(), 'Size:', xlsxBlob.getBytes().length, 'bytes');
    
    // Email 1: Detailed email to hemantpb123@gmail.com with all details
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('Sending detailed email to:', ERROR_EMAIL);
    
    const detailedSubject = `âœ… Order ${orderData.orderNumber} Processed Successfully`;
    const detailedBody = `Order Processing Complete!\n\n` +
      `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
      `ORDER DETAILS\n` +
      `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
      `Order Number: ${orderData.orderNumber}\n` +
      `Party Name: ${orderData.partyName}\n` +
      `Order Date: ${orderData.orderDate}\n` +
      `Total Items: ${orderData.items.length}\n\n` +
      `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
      `PROCESSING SUMMARY\n` +
      `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
      `âœ“ Matched Items: ${matchResult.matched}\n` +
      `${matchResult.unmatched.length > 0 ? 'âœ—' : 'âœ“'} Unmatched Items: ${matchResult.unmatched.length}\n\n` +
      `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
      `UNMATCHED ITEMS\n` +
      `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
      `${unmatchedText}\n\n` +
      `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
      `FILE DETAILS\n` +
      `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
      `File Name: ${processedFileName}\n` +
      `Processed: ${timestamp}\n\n` +
      `ğŸ“¥ Download Link:\n${driveLink}\n\n` +
      `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
      `This is an automated email from Order Processing System`;
    
    try {
      GmailApp.sendEmail(ERROR_EMAIL, detailedSubject, detailedBody, {
        attachments: [xlsxBlob],
        name: 'Order Processing System'
      });
      console.log('âœ… Detailed email sent to:', ERROR_EMAIL);
    } catch (detailedEmailErr) {
      console.error('âŒ Failed to send detailed email:', detailedEmailErr.message);
    }
    
    // Email 2: Professional email to vishalkulkarni@modenik.in with CC
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('Sending professional email to:', ORDER_EMAIL);
    console.log('CC:', ORDER_EMAIL_CC);
    
    try {
      const professionalSubject = `Enamor Order - Kambeshwar Agencies`;
      
      // Create HTML email body for professional look
      const htmlBody = `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enamor Purchase Order</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Georgia', 'Times New Roman', serif;
      line-height: 1.6;
      background: #f5f5f5;
    }

    .email-container {
      max-width: 600px;
      margin: 0 auto;
      background: #ffffff;
      border: 1px solid #e0e0e0;
    }

    .gold-border-top {
      height: 4px;
      background: #d4af37;
    }

    .header-section {
      background: 
        repeating-linear-gradient(
          45deg,
          #0a0a0a,
          #0a0a0a 1px,
          #1a1a1a 1px,
          #1a1a1a 2px
        ),
        repeating-linear-gradient(
          -45deg,
          #0a0a0a,
          #0a0a0a 1px,
          #1a1a1a 1px,
          #1a1a1a 2px
        ),
        linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%);
      background-blend-mode: multiply, multiply, normal;
      padding: 40px 20px;
      text-align: center;
      border-bottom: 2px solid #d4af37;
      position: relative;
    }
    
    .header-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(ellipse at 20% 30%, rgba(212, 175, 55, 0.05) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 70%, rgba(212, 175, 55, 0.05) 0%, transparent 50%);
      pointer-events: none;
    }

    .decorative-symbol {
      color: #d4af37;
      font-size: 24px;
      margin-bottom: 15px;
      position: relative;
      z-index: 1;
    }

    .brand-name {
      font-size: 48px;
      font-weight: 300;
      color: #ffffff;
      letter-spacing: 8px;
      margin-bottom: 15px;
      text-transform: uppercase;
      font-family: 'Georgia', serif;
      position: relative;
      z-index: 1;
    }

    .divider-line {
      width: 100px;
      height: 1px;
      background: #d4af37;
      margin: 15px auto;
      position: relative;
      z-index: 1;
    }

    .document-type {
      font-size: 12px;
      color: #d4af37;
      letter-spacing: 3px;
      text-transform: uppercase;
      font-weight: bold;
      position: relative;
      z-index: 1;
    }

    .content-section {
      padding: 30px;
      color: #333333;
    }

    .recipient-box {
      background: #fafafa;
      border-left: 3px solid #d4af37;
      padding: 15px;
      margin-bottom: 25px;
    }

    .recipient-name {
      font-size: 16px;
      font-weight: bold;
      color: #1a1a1a;
      margin-bottom: 5px;
    }

    .recipient-division {
      font-size: 14px;
      color: #666666;
      font-style: italic;
    }

    .salutation {
      font-size: 14px;
      color: #333333;
      margin-bottom: 15px;
      font-style: italic;
    }

    .body-text {
      font-size: 14px;
      line-height: 1.7;
      color: #333333;
      margin-bottom: 15px;
      text-align: justify;
      word-spacing: normal;
      hyphens: auto;
    }

    .attachment-label {
      font-size: 11px;
      color: #888888;
      letter-spacing: 2px;
      text-transform: uppercase;
      margin: 25px 0 15px 0;
      text-align: center;
      font-weight: bold;
    }

    .attachment-card {
      background: 
        repeating-linear-gradient(
          45deg,
          #0a0a0a,
          #0a0a0a 1px,
          #1a1a1a 1px,
          #1a1a1a 2px
        ),
        repeating-linear-gradient(
          -45deg,
          #0a0a0a,
          #0a0a0a 1px,
          #1a1a1a 1px,
          #1a1a1a 2px
        ),
        linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
      background-blend-mode: multiply, multiply, normal;
      border: 1px solid #d4af37;
      border-radius: 4px;
      padding: 20px;
      display: table;
      width: 100%;
      position: relative;
    }
    
    .attachment-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(ellipse at 30% 50%, rgba(212, 175, 55, 0.03) 0%, transparent 50%);
      pointer-events: none;
      border-radius: 4px;
    }

    .file-details {
      display: table-cell;
      vertical-align: middle;
      position: relative;
      z-index: 1;
    }

    .file-type {
      font-size: 11px;
      color: #d4af37;
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-bottom: 8px;
      font-weight: bold;
    }

    .file-name {
      font-size: 16px;
      color: #ffffff;
      font-weight: bold;
      font-family: 'Courier New', monospace;
      margin-bottom: 5px;
      word-break: break-word;
    }

    .closing-text {
      font-size: 14px;
      line-height: 1.7;
      color: #333333;
      margin-top: 20px;
      margin-bottom: 15px;
      text-align: justify;
      word-spacing: normal;
      hyphens: auto;
    }

    .signature-section {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
      text-align: left;
    }

    .signature-divider {
      text-align: center;
      color: #d4af37;
      margin-bottom: 15px;
      font-size: 14px;
    }

    .regards {
      font-size: 13px;
      color: #666666;
      margin-bottom: 12px;
      font-style: italic;
    }

    .company-name {
      font-size: 16px;
      color: #1a1a1a;
      font-weight: bold;
      letter-spacing: 2px;
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    .company-role {
      font-size: 12px;
      color: #d4af37;
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-bottom: 4px;
      font-weight: bold;
    }

    .company-location {
      font-size: 12px;
      color: #999999;
    }

    .footer-section {
      background: linear-gradient(180deg, #fafafa 0%, #f5f5f5 100%);
      padding: 20px;
      border-top: 2px solid #d4af37;
      text-align: center;
      font-size: 11px;
      color: #999999;
      letter-spacing: 1px;
    }

    .system-info {
      margin-bottom: 10px;
      text-transform: uppercase;
      font-weight: bold;
    }

    .developer-credit {
      font-size: 10px;
      color: #aaaaaa;
    }

    .developer-credit span {
      color: #666666;
      font-weight: bold;
    }

    @media only screen and (max-width: 480px) {
      .email-container {
        width: 100% !important;
      }

      .brand-name {
        font-size: 32px;
        letter-spacing: 4px;
      }

      .header-section {
        padding: 25px 15px;
      }

      .content-section {
        padding: 20px;
      }

      .body-text,
      .closing-text {
        text-align: left;
        word-spacing: normal;
        hyphens: none;
      }
    }
  </style>
</head>
<body>
  <div class="email-container">
    <!-- Gold Top Border -->
    <div class="gold-border-top"></div>

    <!-- Header Section -->
    <div class="header-section">
      <div class="decorative-symbol">âœ¦</div>
      <div class="brand-name">ENAMOR</div>
      <div class="divider-line"></div>
      <div class="document-type">Purchase Order</div>
    </div>

    <!-- Content Section -->
    <div class="content-section">
      <!-- Recipient Information -->
      <div class="recipient-box">
        <div class="recipient-name">Modenik Lifestyle Private Limited</div>
        <div class="recipient-division">Enamor Division</div>
      </div>

      <!-- Salutation -->
      <div class="salutation">
        Dear Vishal Ji,
      </div>

      <!-- Body Text -->
      <div class="body-text">
        Kindly find the attached purchase order for your esteemed consideration and prompt processing.
      </div>

      <!-- Attachment Section -->
      <div class="attachment-label">
        â—† Enclosed Documentation â—†
      </div>

      <div class="attachment-card">
        <div class="file-details">
          <div class="file-type">Excel Spreadsheet Document</div>
          <div class="file-name">ORDER_${orderData.orderNumber}.xlsx</div>
        </div>
      </div>

      <!-- Closing Messages -->
      <div class="closing-text">
        The enclosed document contains complete order specifications and exact quantities.
      </div>

      <div class="closing-text">
        We truly value our partnership and look forward to your quick confirmation.
      </div>

      <!-- Signature Section -->
      <div class="signature-section">
        <div class="signature-divider">â—†</div>
        <div class="regards">With the highest regards,</div>
        <div class="company-name">Kambeshwar Agencies</div>
        <div class="company-role">Authorized Enamor Distributor</div>
        <div class="company-location">Goa, India</div>
      </div>
    </div>

    <!-- Footer Section -->
    <div class="footer-section">
      <div class="system-info">
        Automated Order Management
      </div>
      <div class="developer-credit">
        Engineered by <span>Hemant Borana</span>
      </div>
    </div>
  </div>
</body>
</html>`;
      
      // Plain text version for email clients that don't support HTML
      const plainTextBody = `Dear Modenik Lifestyle Pvt Ltd (Enamor Division),

I hope this email finds you well.

Please find the attached Enamor order to this email.

Attachment: ORDER_${orderData.orderNumber}.xlsx

Thank you for your attention to this matter.

Best regards,
Kambeshwar Agencies
Authorized Enamor Distributor (Goa)`;
      
      console.log('Email subject:', professionalSubject);
      console.log('CC:', ORDER_EMAIL_CC);
      console.log('Attachment:', xlsxBlob.getName());
      
      GmailApp.sendEmail(ORDER_EMAIL, professionalSubject, plainTextBody, {
        cc: ORDER_EMAIL_CC,
        attachments: [xlsxBlob],
        name: 'Kambeshwar Agencies',
        htmlBody: htmlBody
      });
      
      console.log('âœ… Professional email SUCCESSFULLY sent to:', ORDER_EMAIL);
      console.log('âœ… CC sent to:', ORDER_EMAIL_CC);
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      
    } catch (orderEmailErr) {
      console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      console.error('âŒ Professional email FAILED!');
      console.error('Error:', orderEmailErr.message);
      console.error('Error stack:', orderEmailErr.stack);
      console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      
      // Send error notification
      sendErrorEmail(`Failed to send order email to ${ORDER_EMAIL}\n\nError: ${orderEmailErr.message}\n\nOrder: ${orderData.orderNumber}`);
    }
    
  } catch (err) {
    console.error('Email sending failed:', err.message);
    console.error('Stack:', err.stack);
  }
}

/**
 * Convert Google Sheet to XLSX blob
 */
function convertSheetToXlsx(spreadsheet, orderNumber) {
  try {
    const url = `https://docs.google.com/spreadsheets/d/${spreadsheet.getId()}/export?format=xlsx`;
    const token = ScriptApp.getOAuthToken();
    
    const response = UrlFetchApp.fetch(url, {
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });
    
    const xlsxBlob = response.getBlob();
    xlsxBlob.setName(`ORDER_${orderNumber}.xlsx`);
    
    console.log('âœ… Converted to XLSX:', xlsxBlob.getName());
    return xlsxBlob;
  } catch (err) {
    console.error('XLSX conversion failed:', err);
    throw new Error('Failed to convert to XLSX: ' + err.message);
  }
}

/**
 * Send error notification email with detailed debug info
 */
function sendErrorEmail(errorMsg, debugInfo = null) {
  try {
    const timestamp = new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });
    
    const subject = 'âŒ Order Processing Error';
    let body = `Order Processing Failed!\n\n` +
      `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
      `ERROR DETAILS\n` +
      `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
      `Error: ${errorMsg}\n` +
      `Time: ${timestamp}\n\n`;
    
    // Add debug info if available
    if (debugInfo) {
      body += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
        `DEBUG INFORMATION\n` +
        `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
      
      if (debugInfo.orderData) {
        body += `\nOrder Number: ${debugInfo.orderData.orderNumber || 'N/A'}\n`;
        body += `Party Name: ${debugInfo.orderData.partyName || 'N/A'}\n`;
        body += `Order Date: ${debugInfo.orderData.orderDate || 'N/A'}\n`;
      }
      
      if (debugInfo.items) {
        body += `\nItems to Match (${debugInfo.items.length}):\n`;
        debugInfo.items.forEach((item, idx) => {
          body += `  ${idx + 1}. Barcode: [${item.barcode}] | Qty: ${item.quantity}\n`;
        });
      }
      
      if (debugInfo.unmatched && debugInfo.unmatched.length > 0) {
        body += `\nUnmatched Items (${debugInfo.unmatched.length}):\n`;
        debugInfo.unmatched.forEach((item, idx) => {
          body += `  ${idx + 1}. ${item}\n`;
        });
      }
      
      body += `\n`;
    }
    
    body += `Please check the Apps Script logs for more details.\n\n` +
      `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`;
    
    GmailApp.sendEmail(ERROR_EMAIL, subject, body);
    console.log('âœ… Error email sent to:', ERROR_EMAIL);
  } catch (err) {
    console.error('Error email failed:', err.message);
  }
}